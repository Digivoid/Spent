<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard - Spent Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .category-color {
    width: 15px;
    height: 15px;
    display: inline-block;
    margin-right: 5px;
  }
</style>
</head>
<body class="bg-light">
<div class="container mt-5">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Dashboard</h2>
    <div>
      <a href="/expenses/add" class="btn btn-primary me-2">Add Expense</a>
      <a href="/" class="btn btn-secondary">Logout</a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card text-white bg-primary p-3">
        <h5>Total Expenses</h5>
        <h3>€<%= totalExpenses || 0 %></h3>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card text-dark bg-light p-3">
        <h5>Recent Expenses</h5>
        <ul class="list-group list-group-flush">
          <% recentExpenses.forEach(e => { %>
            <li class="list-group-item">
              €<%= e.amount %> - <%= e.category %> <%= e.subcategory ? '(' + e.subcategory + ')' : '' %>
            </li>
          <% }) %>
          <% if(recentExpenses.length === 0){ %>
            <li class="list-group-item">No expenses yet</li>
          <% } %>
        </ul>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card p-3 mb-4">
    <canvas id="categoryChart" style="max-width:600px;"></canvas>
  </div>

  <!-- Expense Table -->
  <div class="card p-3">
    <h4>All Expenses</h4>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Amount (€)</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Note</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% data.forEach(d => { %>
          <tr>
            <td><%= d.total %></td>
            <td>
              <span class="category-color" style="background-color:<%= d.color || '#007bff' %>"></span>
              <%= d.category %>
            </td>
            <td><%= d.subcategory || '-' %></td>
            <td><%= d.note || '-' %></td>
            <td><%= d.date || '-' %></td>
            <td>
              <a href="/expenses/edit/<%= d.id %>" class="btn btn-sm btn-success">Edit</a>
              <a href="/expenses/delete/<%= d.id %>" class="btn btn-sm btn-danger" onclick="return confirm('Delete this expense?')">Delete</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

</div>

<script>
const categories = [<%= data.map(d => `'${d.category} - ${d.subcategory || ''}'`).join(',') %>];
const amounts = [<%= data.map(d => d.total).join(',') %>];
const colors = [<%= data.map(d => `'${d.color || '#007bff'}'`).join(',') %>];

const ctx = document.getElementById('categoryChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: categories,
        datasets: [{
            label: 'Expenses',
            data: amounts,
            backgroundColor: colors,
        }]
    }
});
</script>
</body>
</html>
