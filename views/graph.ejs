<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Spent Tracker</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">Spent</h1>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <span class="theme-icon">ðŸŒ™</span>
                </button>
            </div>

            <div class="nav-menu">
                <a href="/dashboard" class="nav-item">
                    <span class="nav-icon">ðŸ“Š</span>
                    <span>Dashboard</span>
                </a>
                <a href="/all-expenses" class="nav-item">
                    <span class="nav-icon">ðŸ’°</span>
                    <span>All Expenses</span>
                </a>
                <a href="/expenses/add" class="nav-item">
                    <span class="nav-icon">âž•</span>
                    <span>Add Expense</span>
                </a>
                <a href="/graph" class="nav-item active">
                    <span class="nav-icon">ðŸ“ˆ</span>
                    <span>Analytics</span>
                </a>
            </div>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar"><%= username.charAt(0).toUpperCase() %></div>
                    <span class="user-name"><%= username %></span>
                </div>
                <a href="/settings" class="btn" style="width: 100%; margin-top: var(--space-md); background-color: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); text-align: center; padding: var(--space-md);">Settings</a>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="page-header">
                <div class="header-content">
                    <h2>Analytics</h2>
                    <p class="header-subtitle">Visual breakdown and detailed reports</p>
                </div>
            </header>

            <% if (data && data.length > 0) { %>
                <!-- Chart Section -->
                <section style="padding: var(--space-2xl) var(--space-2xl) 0;">
                    <div class="card" style="max-width: 900px; margin: 0 auto;">
                        <div class="card-header">
                            <h3>Spending by Category</h3>
                            <span style="color: var(--text-secondary); font-size: 14px;">Total: â‚¬<%= total.toFixed(2) %></span>
                        </div>
                        <div class="card-body" style="padding: var(--space-2xl);">
                            <div style="max-width: 500px; margin: 0 auto;">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Category Breakdown -->
                <section style="padding: var(--space-2xl);">
                    <div class="card" style="max-width: 900px; margin: 0 auto;">
                        <div class="card-header">
                            <h3>Category Breakdown</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: var(--space-sm);">
                                <% data.forEach(item => { %>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-md); background-color: var(--bg-primary); border-radius: var(--radius-md);">
                                        <div style="display: flex; align-items: center; gap: var(--space-md); flex: 1;">
                                            <div style="width: 16px; height: 16px; border-radius: 50%; background-color: <%= item.color %>; flex-shrink: 0;"></div>
                                            <span style="font-weight: 500; color: var(--text-primary);"><%= item.category %><% if(item.subcategory) { %> - <%= item.subcategory %><% } %></span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-xl);">
                                            <span style="color: var(--text-secondary); font-size: 14px; min-width: 50px; text-align: right;"><%= ((item.total / total) * 100).toFixed(1) %>%</span>
                                            <span style="color: var(--accent); font-weight: 600; font-size: 18px; min-width: 100px; text-align: right;">â‚¬<%= item.total.toFixed(2) %></span>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Detailed Report Table -->
                <section style="padding: 0 var(--space-2xl) var(--space-2xl);">
                    <div class="card" style="max-width: 900px; margin: 0 auto;">
                        <div class="card-header">
                            <h3>Detailed Report</h3>
                            <span style="color: var(--text-secondary); font-size: 14px;"><%= expenses.length %> entries</span>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% expenses.forEach(exp => { %>
                                            <tr>
                                                <td><%= new Date(exp.date).toLocaleDateString('de-DE') %></td>
                                                <td>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: <%= exp.color %>; flex-shrink: 0;"></div>
                                                        <%= exp.category %>
                                                    </div>
                                                </td>
                                                <td>
                                                    <% if (exp.subcategory) { %>
                                                        <div><%= exp.subcategory %></div>
                                                    <% } %>
                                                    <% if (exp.note) { %>
                                                        <div style="color: var(--text-secondary); font-size: 13px;"><%= exp.note %></div>
                                                    <% } %>
                                                    <% if (!exp.subcategory && !exp.note) { %>
                                                        <span style="color: var(--text-secondary);">-</span>
                                                    <% } %>
                                                </td>
                                                <td class="amount-cell">â‚¬<%= exp.amount.toFixed(2) %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

            <% } else { %>
                <!-- Empty State -->
                <section style="padding: var(--space-2xl);">
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <div class="card-body">
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                <div style="font-size: 80px; margin-bottom: 24px; opacity: 0.3;">ðŸ“Š</div>
                                <p style="font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">No data to analyze</p>
                                <p style="font-size: 16px; margin-bottom: 32px;">Add some expenses to see charts and insights</p>
                                <a href="/expenses/add" class="btn btn-primary" style="max-width: 220px; margin: 0 auto;">Add First Expense</a>
                            </div>
                        </div>
                    </div>
                </section>
            <% } %>
        </main>
    </div>

    <script src="/js/theme.js"></script>
    <script src="/js/charts.js"></script>
    <script>
        <% if (data && data.length > 0) { %>
            const chartData = {
                labels: <%= JSON.stringify(data.map(d => d.category + (d.subcategory ? ' - ' + d.subcategory : ''))) %>,
                datasets: [{
                    data: <%= JSON.stringify(data.map(d => d.total)) %>,
                    backgroundColor: <%= JSON.stringify(data.map(d => d.color)) %>,
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 2
                }]
            };

            console.log('Initializing chart with data:', chartData);
            
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    initChart('categoryChart', chartData);
                });
            } else {
                initChart('categoryChart', chartData);
            }
        <% } %>
    </script>
</body>
</html>
